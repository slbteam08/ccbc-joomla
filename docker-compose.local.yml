services:

  db:
    image: mariadb:10.11
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: ccbc_2025
      MYSQL_USER: joomla
      MYSQL_PASSWORD: examplepass
    volumes:
      - db_data:/var/lib/mysql

  joomla:
    build: .
    image: ccbc-joomla:ro
    restart: always
    ports:
      - 8090:80
    depends_on:
      - db
    environment:
      JOOMLA_DB_HOST: db
      JOOMLA_DB_USER: joomla
      JOOMLA_DB_PASSWORD: examplepass
      JOOMLA_DB_NAME: ccbc_2025
      JOOMLA_DB_PREFIX: ccbc2025_
      JOOMLA_SITE_NAME: Joomla Local Test - Read-Only
      JOOMLA_ADMIN_USER: Admin
      JOOMLA_ADMIN_USERNAME: admin
      JOOMLA_ADMIN_PASSWORD: admin123
      JOOMLA_ADMIN_EMAIL: admin@localhost
    volumes:
      # Code is baked into the image (read-only)
      # Only mount writable directories as volumes
      - joomla_images:/var/www/html/images
      - joomla_tmp:/var/www/html/tmp
      - joomla_cache:/var/www/html/cache
      - joomla_admin_cache:/var/www/html/administrator/cache
      - joomla_admin_logs:/var/www/html/administrator/logs
      - joomla_plugins:/var/www/html/plugins
      - joomla_components:/var/www/html/components
      - joomla_modules:/var/www/html/modules

# Named volumes for Joomla writable directories
volumes:
  db_data:
    driver: local
  joomla_images:
    driver: local
  joomla_tmp:
    driver: local
  joomla_cache:
    driver: local
  joomla_admin_cache:
    driver: local
  joomla_admin_logs:
    driver: local
  joomla_plugins:
    driver: local
  joomla_components:
    driver: local
  joomla_modules:
    driver: local
